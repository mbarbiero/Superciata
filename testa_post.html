<!DOCTYPE html>
<html>
<head>
    <title>Teste de Timeout</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        .loading { background: #fff3cd; }
    </style>
</head>
<body>
    <h1>Teste de Timeout - Upload de Arquivos</h1>
    
    <div class="test" id="test1">
        <h3>Teste 1: Conexão Básica</h3>
        <button onclick="testConnection()">Testar Conexão</button>
        <div id="result1"></div>
    </div>

    <div class="test" id="test2">
        <h3>Teste 2: Upload Pequeno (1KB)</h3>
        <button onclick="testSmallUpload()">Testar Upload Pequeno</button>
        <div id="result2"></div>
    </div>

    <div class="test" id="test3">
        <h3>Teste 3: Upload Grande (50KB+)</h3>
        <input type="file" id="largeFile" accept=".zip">
        <button onclick="testLargeUpload()">Testar Upload Grande</button>
        <div id="result3"></div>
    </div>

    <div class="test" id="test4">
        <h3>Teste 4: Upload com Timeout Controlado</h3>
        <button onclick="testWithTimeout()">Testar com Timeout 30s</button>
        <div id="result4"></div>
    </div>

    <script>
        function logResult(elementId, message, isSuccess) {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = isSuccess ? 'success' : 'error';
        }

        // Teste 1: Conexão básica
        async function testConnection() {
            logResult('result1', '⏳ Testando conexão...', true);
            try {
                const start = Date.now();
                const response = await fetch('http://smuu.com.br:21067/superciata/');
                const end = Date.now();
                logResult('result1', `✅ Conexão OK! Tempo: ${end - start}ms<br>Status: ${response.status}`, true);
            } catch (error) {
                logResult('result1', `❌ Erro: ${error.message}`, false);
            }
        }

        // Teste 2: Upload pequeno
        async function testSmallUpload() {
            logResult('result2', '⏳ Enviando arquivo pequeno...', true);
            try {
                // Criar arquivo de teste pequeno
                const smallFile = new File(['X'.repeat(1024)], 'teste.txt');
                const formData = new FormData();
                formData.append('upload-cnefe', smallFile);

                const start = Date.now();
                const response = await fetch('http://smuu.com.br:21067/carrega-cnefe', {
                    method: 'POST',
                    body: formData
                });
                const end = Date.now();

                if (response.ok) {
                    const data = await response.json();
                    logResult('result2', `✅ Upload pequeno OK! Tempo: ${end - start}ms<br>Resposta: ${JSON.stringify(data)}`, true);
                } else {
                    logResult('result2', `❌ Erro HTTP: ${response.status}`, false);
                }
            } catch (error) {
                logResult('result2', `❌ Erro: ${error.message}`, false);
            }
        }

        // Teste 3: Upload grande
        async function testLargeUpload() {
            const fileInput = document.getElementById('largeFile');
            if (!fileInput.files.length) {
                alert('Selecione um arquivo grande primeiro!');
                return;
            }

            const file = fileInput.files[0];
            logResult('result3', `⏳ Enviando arquivo grande: ${formatFileSize(file.size)}...`, true);

            const formData = new FormData();
            formData.append('upload-cnefe', file);

            try {
                const start = Date.now();
                const response = await fetch('http://smuu.com.br:21067/carrega-cnefe', {
                    method: 'POST',
                    body: formData
                });
                const end = Date.now();

                if (response.ok) {
                    const data = await response.json();
                    logResult('result3', `✅ Upload grande OK! Tempo: ${end - start}ms<br>Tamanho: ${formatFileSize(file.size)}`, true);
                } else {
                    logResult('result3', `❌ Erro HTTP: ${response.status}`, false);
                }
            } catch (error) {
                logResult('result3', `❌ Erro: ${error.message}<br>Tipo: ${error.name}`, false);
            }
        }

        // Teste 4: Upload com timeout controlado
        async function testWithTimeout() {
            const fileInput = document.getElementById('largeFile');
            if (!fileInput.files.length) {
                alert('Selecione um arquivo primeiro!');
                return;
            }

            const file = fileInput.files[0];
            logResult('result4', `⏳ Testando com timeout de 30s...`, true);

            const formData = new FormData();
            formData.append('upload-cnefe', file);

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);

                const start = Date.now();
                const response = await fetch('http://smuu.com.br:21067/carrega-cnefe', {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });
                const end = Date.now();

                clearTimeout(timeoutId);

                if (response.ok) {
                    const data = await response.json();
                    logResult('result4', `✅ Upload com timeout OK! Tempo: ${end - start}ms`, true);
                } else {
                    logResult('result4', `❌ Erro HTTP: ${response.status}`, false);
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    logResult('result4', `⏰ TIMEOUT! O upload excedeu 30 segundos`, false);
                } else {
                    logResult('result4', `❌ Erro: ${error.message}`, false);
                }
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>